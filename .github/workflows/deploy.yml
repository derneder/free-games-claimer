name: Deploy to Production

on:
  push:
    branches:
      - main
    tags:
      - 'v*'
  workflow_dispatch:
    inputs:
      environment:
        description: 'Deployment environment'
        required: true
        default: 'staging'
        type: choice
        options:
          - staging
          - production

jobs:
  deploy:
    runs-on: ubuntu-latest
    environment:
      name: ${{ github.ref_name == 'main' && 'production' || 'staging' }}
      url: https://freegamesclaimer.com
    permissions:
      contents: read
      packages: read

    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Set deployment environment
        id: env
        run: |
          if [[ "${{ github.ref }}" == "refs/tags/v"* ]]; then
            echo "ENVIRONMENT=production" >> $GITHUB_OUTPUT
            echo "IMAGE_TAG=${GITHUB_REF#refs/tags/}" >> $GITHUB_OUTPUT
          else
            echo "ENVIRONMENT=staging" >> $GITHUB_OUTPUT
            echo "IMAGE_TAG=latest" >> $GITHUB_OUTPUT
          fi

      - name: Deploy via SSH
        uses: appleboy/ssh-action@master
        with:
          host: ${{ secrets.DEPLOY_HOST }}
          username: ${{ secrets.DEPLOY_USER }}
          key: ${{ secrets.DEPLOY_KEY }}
          port: ${{ secrets.DEPLOY_PORT }}
          script: |
            cd /var/www/free-games-claimer
            git fetch origin
            git checkout ${{ github.ref_name }}
            
            # Pull latest images
            docker pull ${{ secrets.DOCKER_USERNAME }}/free-games-backend:${{ steps.env.outputs.IMAGE_TAG }}
            docker pull ${{ secrets.DOCKER_USERNAME }}/free-games-frontend:${{ steps.env.outputs.IMAGE_TAG }}
            
            # Update docker-compose
            sed -i "s/IMAGE_TAG=.*/IMAGE_TAG=${{ steps.env.outputs.IMAGE_TAG }}/" .env
            
            # Restart services
            docker-compose down
            docker-compose up -d
            
            # Run migrations
            docker-compose exec -T backend npm run migrate
            
            # Health check
            sleep 10
            curl -f http://localhost:3000/api/health || exit 1

      - name: Post deployment notification
        if: always()
        uses: appleboy/telegram-action@master
        with:
          to: ${{ secrets.TELEGRAM_CHAT_ID }}
          token: ${{ secrets.TELEGRAM_BOT_TOKEN }}
          message: |
            ðŸš€ Deployment ${{ job.status }}
            Environment: ${{ steps.env.outputs.ENVIRONMENT }}
            Ref: ${{ github.ref_name }}
            Commit: ${{ github.sha }}

      - name: Rollback on failure
        if: failure()
        uses: appleboy/ssh-action@master
        with:
          host: ${{ secrets.DEPLOY_HOST }}
          username: ${{ secrets.DEPLOY_USER }}
          key: ${{ secrets.DEPLOY_KEY }}
          port: ${{ secrets.DEPLOY_PORT }}
          script: |
            cd /var/www/free-games-claimer
            git checkout HEAD~1
            docker-compose restart
