import express from 'express';\nimport db from '../config/database.js';\nimport logger from '../config/logger.js';\nimport { authenticate, authorize } from '../middleware/auth.js';\nimport { NotFoundError } from '../utils/errors.js';\n\nconst router = express.Router();\n\n// Middleware: Only admins\nrouter.use(authenticate);\nrouter.use(authorize(['admin']));\n\n// ============ GET ALL USERS ============\nrouter.get('/users', async (req, res, next) => {\n  try {\n    const { page = 1, limit = 20 } = req.query;\n    const offset = (page - 1) * limit;\n\n    const users = await db('users')\n      .select('id', 'email', 'username', 'role', 'is_active', 'two_factor_enabled', 'created_at')\n      .orderBy('created_at', 'desc')\n      .limit(parseInt(limit))\n      .offset(offset);\n\n    const [{ count }] = await db('users').count('* as count');\n\n    logger.info(`ğŸ“‹ Admin listed users: ${count} total`);\n\n    res.json({\n      users,\n      pagination: {\n        page: parseInt(page),\n        limit: parseInt(limit),\n        total: count,\n        pages: Math.ceil(count / limit),\n      },\n    });\n  } catch (error) {\n    next(error);\n  }\n});\n\n// ============ GET SYSTEM STATS ============\nrouter.get('/stats', async (req, res, next) => {\n  try {\n    const [{ totalUsers }] = await db('users').count('* as totalUsers');\n    const [{ activeUsers }] = await db('users')\n      .where({ is_active: true })\n      .count('* as activeUsers');\n    const [{ totalGames }] = await db('games').count('* as totalGames');\n    const [{ totalValue }] = await db('games').sum('steam_price_usd as totalValue');\n\n    const sources = await db('games')\n      .select('source')\n      .count('* as count')\n      .groupBy('source');\n\n    logger.info('ğŸ“Š Admin requested system stats');\n\n    res.json({\n      users: {\n        total: totalUsers || 0,\n        active: activeUsers || 0,\n        inactive: (totalUsers || 0) - (activeUsers || 0),\n      },\n      games: {\n        total: totalGames || 0,\n        totalValue: parseFloat(totalValue) || 0,\n        sources: sources || [],\n      },\n    });\n  } catch (error) {\n    next(error);\n  }\n});\n\n// ============ DEACTIVATE USER ============\nrouter.patch('/users/:id/deactivate', async (req, res, next) => {\n  try {\n    const { id } = req.params;\n\n    const user = await db('users').where({ id }).first();\n    if (!user) {\n      throw new NotFoundError('User not found');\n    }\n\n    if (!user.is_active) {\n      return res.status(400).json({ message: 'User already deactivated' });\n    }\n\n    await db('users').where({ id }).update({\n      is_active: false,\n      updated_at: new Date(),\n    });\n\n    logger.warn(\n      `âš ï¸  User deactivated: ${user.email} (ID: ${user.id}) by admin: ${req.user.email}`\n    );\n\n    res.json({\n      message: 'User deactivated successfully',\n      user: {\n        id: user.id,\n        email: user.email,\n        username: user.username,\n        is_active: false,\n      },\n    });\n  } catch (error) {\n    next(error);\n  }\n});\n\n// ============ ACTIVATE USER ============\nrouter.patch('/users/:id/activate', async (req, res, next) => {\n  try {\n    const { id } = req.params;\n\n    const user = await db('users').where({ id }).first();\n    if (!user) {\n      throw new NotFoundError('User not found');\n    }\n\n    if (user.is_active) {\n      return res.status(400).json({ message: 'User already active' });\n    }\n\n    await db('users').where({ id }).update({\n      is_active: true,\n      updated_at: new Date(),\n    });\n\n    logger.info(`âœ… User activated: ${user.email} (ID: ${user.id}) by admin: ${req.user.email}`);\n\n    res.json({\n      message: 'User activated successfully',\n      user: {\n        id: user.id,\n        email: user.email,\n        username: user.username,\n        is_active: true,\n      },\n    });\n  } catch (error) {\n    next(error);\n  }\n});\n\n// ============ VIEW AUDIT LOGS ============\nrouter.get('/logs', async (req, res, next) => {\n  try {\n    const { limit = 50, offset = 0 } = req.query;\n\n    const logs = await db('audit_logs')\n      .select('*')\n      .orderBy('created_at', 'desc')\n      .limit(parseInt(limit))\n      .offset(parseInt(offset));\n\n    const [{ count }] = await db('audit_logs').count('* as count');\n\n    logger.info(`ğŸ“‹ Admin viewed audit logs: ${logs.length} entries`);\n\n    res.json({\n      logs: logs || [],\n      pagination: {\n        limit: parseInt(limit),\n        offset: parseInt(offset),\n        total: count || 0,\n      },\n    });\n  } catch (error) {\n    next(error);\n  }\n});\n\n// ============ GET USER DETAILS ============\nrouter.get('/users/:id', async (req, res, next) => {\n  try {\n    const { id } = req.params;\n\n    const user = await db('users').where({ id }).first();\n    if (!user) {\n      throw new NotFoundError('User not found');\n    }\n\n    const gameCount = await db('games').where({ user_id: id }).count('* as count').first();\n    const activityLogs = await db('game_logs')\n      .where({ user_id: id })\n      .orderBy('created_at', 'desc')\n      .limit(10);\n\n    logger.info(`ğŸ‘¤ Admin viewed user details: ${user.email}`);\n\n    res.json({\n      user: {\n        id: user.id,\n        email: user.email,\n        username: user.username,\n        role: user.role,\n        is_active: user.is_active,\n        two_factor_enabled: user.two_factor_enabled,\n        created_at: user.created_at,\n        updated_at: user.updated_at,\n      },\n      stats: {\n        totalGames: gameCount?.count || 0,\n        recentActivity: activityLogs || [],\n      },\n    });\n  } catch (error) {\n    next(error);\n  }\n});\n\n// ============ DELETE USER ============\nrouter.delete('/users/:id', async (req, res, next) => {\n  try {\n    const { id } = req.params;\n\n    const user = await db('users').where({ id }).first();\n    if (!user) {\n      throw new NotFoundError('User not found');\n    }\n\n    // Prevent deleting yourself\n    if (user.id === req.user.id) {\n      return res.status(400).json({ message: 'Cannot delete your own account' });\n    }\n\n    // Delete cascade will handle related records\n    await db('users').where({ id }).delete();\n\n    logger.warn(`ğŸ—‘ï¸  User deleted: ${user.email} (ID: ${user.id}) by admin: ${req.user.email}`);\n\n    res.json({\n      message: 'User deleted successfully',\n      user: {\n        id: user.id,\n        email: user.email,\n      },\n    });\n  } catch (error) {\n    next(error);\n  }\n});\n\nexport default router;\n